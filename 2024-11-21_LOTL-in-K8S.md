---

tags: 云原生安全资讯,安全会议,k8s,利用技术,躲避防御
spec: v0.1.0
version: v0.1.0

---

# 安全会议学习: [KubeCon + CloudNativeCon Europe 2024]: Living off the Land Techniques in Managed Kubernetes Clusters - Ronen Shustin&Shay Berkovich, Wiz

| Item            | Content        | Note     |
|-----------------|----------------|----------|
| Talk Name   | Living off the Land Techniques in Managed Kubernetes Clusters |
| Conference Name | KubeCon + CloudNativeCon Europe 2024 |
| Talker          |  Ronen Shustin, Wiz |
| | Shay Berkovich, Wiz |
| Date            | 2024-03-22 |
| Materials       | [schedule](https://kccnceu2024.sched.com/event/1YeRm/living-off-the-land-techniques-in-managed-kubernetes-clusters-ronen-shustin-shay-berkovich-wiz)   |
|                 | [video](https://www.youtube.com/watch?v=aAxl90o910g)      |
|                 | [slide](https://www.researchgate.net/publication/379268729_Living_off_the_Land_Techniques_in_Managed_Kubernetes_Clusters)      |

在托管的Kubernetes集群中利用“土生土长”的技术（Living Off The Land, LOTL）的策略和技术。这些技术主要涉及使用集群内已存在的工具和流程来执行恶意活动，以减少被检测的可能性。

## 1. LOTL

“Living off the land”这个短语是由Christopher Campbell（ @obscuresec）和Matt Graeber @mattifestation）在[DerbyCon 3](https://www.youtube.com/watch?v=j-r6UonEkUw)上创造的。

LOLBins 一词来自 Twitter 上的一次讨论，该讨论涉及攻击者可以如何使用二进制文件来执行超出其原始目的的操作。Philip Goh （@MathCasualty） [提议了 LOLBins](https://twitter.com/MathCasualty/status/969174982579273728)。随后进行了一次高度科学的互联网民意调查，在达成普遍共识 （69%） 后，这个名字被[正式宣布](https://twitter.com/Oddvarmoe/status/985432848961343488)。Jimmy （@bohops） [紧随其后 LOLScripts](https://twitter.com/bohops/status/984828803120881665).

LOTL技术通常涉及使用系统内部的合法工具（如LOLBins）来隐藏恶意行为，使其看起来像正常活动。这种方法可以显著降低恶意行为被发现的风险。

例如在传统的网络安全领域，典型的LOTL技术有 [GTFOBins](https://gtfobins.github.io/)、[LOLBAS](https://lolbas-project.github.io/) 。

本次演讲者介绍的是在托管k8s集群中的LOTL技术。

## 2. LOTL in K8S

### 2.1 利用Node Problem Detector

* 背景：Node Problem Detector（NPD）是Kubernetes中用于检测节点问题的工具，通常作为系统服务运行。
* 利用方法：
  * 配置文件修改：攻击者可以修改NPD的配置文件（如sysctl-monitor.json），插入恶意脚本或命令。
  * 脚本执行：利用NPD的自定义插件执行功能，攻击者可以定期执行恶意脚本，如修改系统调用设置（sysctl）。
  * 持久性和逃避：通过定期执行和伪装为正常的NPD活动，恶意行为可以持续存在且难以被侦测。

### 2.2 滥用Fluent Bit

* 背景：Fluent Bit是一个日志处理器和收集器，经常在Kubernetes集群中用于日志管理。
* 利用方法：
  * 配置篡改：修改Fluent Bit的配置（例如在ConfigMap中），注入恶意的输入插件或过滤器配置。
  * 执行插件滥用：利用EXEC插件或其他执行功能，从而在Pod内或主机上执行恶意代码。
  * 数据收集和传输：通过修改日志收集和传输的配置，攻击者可以从集群中悄悄抽取敏感数据。

### 2.3 利用默认的Pod和节点镜像

* 背景：Kubernetes节点和Pod通常会预装多种工具和二进制文件，如bash、curl等。
* 利用方法：
  * 命令和脚本执行：使用这些预装的工具执行攻击活动，如数据窃取、网络侦察或其他恶意操作。
  * 逃避检测：由于这些工具是集群正常操作的一部分，因此使用它们执行的恶意行为更难被标记为异常。

### 2.4 Kubernetes API滥用

* 背景：Kubernetes API是管理集群资源的核心接口。
* 利用方法：
  * 权限提升：通过滥用Kubernetes RBAC（Role-Based Access Control）配置，攻击者可能会尝试获取额外的权限。
  * API调用：利用合法的API调用执行恶意操作，如创建、修改或删除资源，这可能导致服务中断或数据泄露。

## 3. 为什么难以检测

目前，k8s系统级的相关插件，属于安全运营团队的监控盲区。例如NPD案例，作者通过修改其配置文件来实现持久化，再结合恶意命令自身的躲避防御技术，因安全运营团队不熟悉相关插件的行为，很难察觉到异常。

## 4. 防护建议

安全运营团队需要了解LOTL技术，并检查系统级插件、进程的配置文件安全性。

## 3. 启示

针对特定云厂商K8S甚至弹性虚拟机等产品，研究LOTL利用技术，有助于躲避防御。有必要系统性地针对云厂商Agent作全面的漏洞挖掘及可利用性分析。

> This document use [Cloud Native Security News: Researcher Introduction](https://github.com/ssst0n3/security-research-specification/blob/main/cloud-native-security-news/security-conference-talk-learning.md) as template.
