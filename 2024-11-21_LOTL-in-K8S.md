---

tags: äº‘åŸç”Ÿå®‰å…¨èµ„è®¯,å®‰å…¨ä¼šè®®,k8s,åˆ©ç”¨æŠ€æœ¯,èº²é¿é˜²å¾¡
author: ssst0n3
spec: v0.1.0
version: v0.1.2
changelog:
  - v0.1.2: publish to wechat
  - v0.1.1: update slide url

---

# [KubeCon + CloudNativeCon Europe 2024] Living off the Land Techniques in Managed Kubernetes Clusters - Ronen Shustin&Shay Berkovich, Wiz

| Item            | Content        | Note     |
|-----------------|----------------|----------|
| Talk Name   | Living off the Land Techniques in Managed Kubernetes Clusters |
| Conference Name | KubeCon + CloudNativeCon Europe 2024 |
| Talker          |  Ronen Shustin, Wiz |
| | Shay Berkovich, Wiz |
| Date            | 2024-03-22 |
| Materials       | [schedule](https://kccnceu2024.sched.com/event/1YeRm/living-off-the-land-techniques-in-managed-kubernetes-clusters-ronen-shustin-shay-berkovich-wiz)   |
|                 | [video](https://www.youtube.com/watch?v=aAxl90o910g)      |
|                 | [slide](https://static.sched.com/hosted_files/kccnceu2024/fd/LOTLTechniquesInK8s.pdf)      |

åœ¨æ‰˜ç®¡çš„Kubernetesé›†ç¾¤ä¸­åˆ©ç”¨â€œåœŸç”ŸåœŸé•¿â€çš„æŠ€æœ¯ï¼ˆLiving Off The Land, LOTLï¼‰çš„ç­–ç•¥å’ŒæŠ€æœ¯ã€‚è¿™äº›æŠ€æœ¯ä¸»è¦æ¶‰åŠä½¿ç”¨é›†ç¾¤å†…å·²å­˜åœ¨çš„å·¥å…·å’Œæµç¨‹æ¥æ‰§è¡Œæ¶æ„æ´»åŠ¨ï¼Œä»¥å‡å°‘è¢«æ£€æµ‹çš„å¯èƒ½æ€§ã€‚

## 1. LOTL

â€œLiving off the landâ€è¿™ä¸ªçŸ­è¯­æ˜¯ç”±Christopher Campbellï¼ˆ @obscuresecï¼‰å’ŒMatt Graeber @mattifestationï¼‰åœ¨[DerbyCon 3](https://www.youtube.com/watch?v=j-r6UonEkUw)ä¸Šåˆ›é€ çš„ã€‚

LOLBins ä¸€è¯æ¥è‡ª Twitter ä¸Šçš„ä¸€æ¬¡è®¨è®ºï¼Œè¯¥è®¨è®ºæ¶‰åŠæ”»å‡»è€…å¯ä»¥å¦‚ä½•ä½¿ç”¨äºŒè¿›åˆ¶æ–‡ä»¶æ¥æ‰§è¡Œè¶…å‡ºå…¶åŸå§‹ç›®çš„çš„æ“ä½œã€‚Philip Goh ï¼ˆ@MathCasualtyï¼‰ [æè®®äº† LOLBins](https://twitter.com/MathCasualty/status/969174982579273728)ã€‚éšåè¿›è¡Œäº†ä¸€æ¬¡é«˜åº¦ç§‘å­¦çš„äº’è”ç½‘æ°‘æ„è°ƒæŸ¥ï¼Œåœ¨è¾¾æˆæ™®éå…±è¯† ï¼ˆ69%ï¼‰ åï¼Œè¿™ä¸ªåå­—è¢«[æ­£å¼å®£å¸ƒ](https://twitter.com/Oddvarmoe/status/985432848961343488)ã€‚Jimmy ï¼ˆ@bohopsï¼‰ [ç´§éšå…¶å LOLScripts](https://twitter.com/bohops/status/984828803120881665).

LOTLæŠ€æœ¯é€šå¸¸æ¶‰åŠä½¿ç”¨ç³»ç»Ÿå†…éƒ¨çš„åˆæ³•å·¥å…·ï¼ˆå¦‚LOLBinsï¼‰æ¥éšè—æ¶æ„è¡Œä¸ºï¼Œä½¿å…¶çœ‹èµ·æ¥åƒæ­£å¸¸æ´»åŠ¨ã€‚è¿™ç§æ–¹æ³•å¯ä»¥æ˜¾è‘—é™ä½æ¶æ„è¡Œä¸ºè¢«å‘ç°çš„é£é™©ã€‚

ä¾‹å¦‚åœ¨ä¼ ç»Ÿçš„ç½‘ç»œå®‰å…¨é¢†åŸŸï¼Œå…¸å‹çš„LOTLæŠ€æœ¯æœ‰ [GTFOBins](https://gtfobins.github.io/)ã€[LOLBAS](https://lolbas-project.github.io/) ã€‚

æœ¬æ¬¡æ¼”è®²è€…ä»‹ç»çš„æ˜¯åœ¨æ‰˜ç®¡k8sé›†ç¾¤ä¸­çš„LOTLæŠ€æœ¯ï¼Œå¹¶å‘¼ååº”è¯¥å°†ç›¸å…³çš„LOTLç»„ä»¶åŠ å…¥åˆ°å¨èƒçŸ©é˜µä¸­ã€‚

## 2. LOTL in K8S

### 2.1 åˆ©ç”¨Node Problem Detectorå®ç°æŒä¹…åŒ–

Node Problem Detectorï¼ˆNPDï¼‰æ˜¯Kubernetesä¸­ç”¨äºæ£€æµ‹èŠ‚ç‚¹é—®é¢˜çš„å·¥å…·ï¼Œé€šå¸¸ä½œä¸ºç³»ç»ŸæœåŠ¡è¿è¡Œã€‚å…¶é…ç½®æœ‰å®šæœŸæ‰§è¡Œçš„ç‰¹ç‚¹ï¼Œæ”»å‡»è€…å¯ä»¥å€Ÿæ­¤æ¥å®ç°æŒä¹…åŒ–ã€‚

#### 2.1.1 ä¿®æ”¹é…ç½®æ–‡ä»¶

æ”»å‡»è€…å¯ä»¥ä¿®æ”¹NPDçš„é…ç½®æ–‡ä»¶ï¼Œæ’å…¥æ¶æ„è„šæœ¬æˆ–å‘½ä»¤ï¼Œä½†ä¿®æ”¹é…ç½®æ–‡ä»¶éœ€è¦é‡å¯podã€‚

é…ç½®æ–‡ä»¶å½¢å¦‚:

[network-problem-monitor.json](https://github.com/kubernetes/node-problem-detector/blob/e8840b1a7d4af62b5330991d57a7c6959f1c61f7/config/network-problem-monitor.json)

```json
{
  "plugin": "custom",
  "pluginConfig": {
    "invoke_interval": "30s",
    "timeout": "5s",
    "max_output_length": 80,
    "concurrency": 3
  },
  "source": "network-custom-plugin-monitor",
  "metricsReporting": true,
  "conditions": [],
  "rules": [
    {
      "type": "temporary",
      "reason": "ConntrackFull",
      "path": "./config/plugin/network_problem.sh",
      "timeout": "3s"
    }
  ]
}
```

#### 2.1.2 ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„å‘½ä»¤æ‰§è¡Œè„šæœ¬

ä¿®æ”¹æ‰§è¡Œè„šæœ¬å¯ä»¥é¿å…é‡å¯NPD podã€‚ä¾‹å¦‚ä¸Šè¿°é…ç½®æ–‡ä»¶çš„è„šæœ¬ `./config/plugin/network_problem.sh`

### 2.2 åˆ©ç”¨Fluent Bitå®ç°æ•°æ®æ”¶é›†

Fluent Bitæ˜¯ä¸€ä¸ªæ—¥å¿—å¤„ç†å™¨å’Œæ”¶é›†å™¨ï¼Œç»å¸¸åœ¨Kubernetesé›†ç¾¤ä¸­ç”¨äºæ—¥å¿—ç®¡ç†ã€‚é€šè¿‡ä¿®æ”¹æ—¥å¿—æ”¶é›†å’Œä¼ è¾“çš„é…ç½®ï¼Œæ”»å‡»è€…å¯ä»¥ä»é›†ç¾¤ä¸­æ‚„æ‚„æŠ½å–æ•æ„Ÿæ•°æ®ã€‚

#### 2.2.1 é…ç½®ç¯¡æ”¹

ä¿®æ”¹Fluent Bitçš„ConfigMapé…ç½®ï¼Œæ³¨å…¥æ¶æ„çš„è¾“å…¥æ’ä»¶æˆ–è¿‡æ»¤å™¨é…ç½®ã€‚

[fluent-bit-config-kafka-rest.yml](https://github.com/fluent/fluent-bit-kubernetes-logging/blob/c590a9ba0ec1e3034308b2884ec9ffc276bf09a0/fluent-bit-config-kafka-rest.yml)

```yaml
kind: ConfigMap
metadata:
  name: fluent-bit-config-kafka-rest
  namespace: kube-system
apiVersion: v1
data:
  fluent-bit.conf: |-
    [SERVICE]
        Flush          1
        Daemon         Off
        Log_Level      info
        Parsers_File   parsers.conf

    [INPUT]
        Name           tail
        Tag            kube.*
        Path           /var/log/containers/*.log
        Parser         docker
        DB             /var/log/flb_kube.db
        Mem_Buf_Limit  5MB
...
```

#### 2.2.2 å‘½ä»¤æ‰§è¡Œ

INPUTæ¨¡å—ä¹Ÿæ”¯æŒ exec é…ç½®ï¼Œè¯¦è§ï¼šhttps://docs.fluentbit.io/manual/pipeline/inputs/exec

### 2.3 åˆ©ç”¨ AKS Entra ID Auth å®ç°æƒé™æå‡

AKSæä¾›äº†å‡ ç§èº«ä»½éªŒè¯å’Œæˆæƒæ–¹å¼ï¼Œå…¶ä¸­åŒ…æ‹¬ï¼š

* æœ¬åœ°è´¦æˆ· + Kubernetes RBACï¼šä½¿ç”¨Kubernetesè‡ªå¸¦çš„è§’è‰²åŸºç¡€è®¿é—®æ§åˆ¶ã€‚
* Entra ID + Kubernetes RBACï¼šé€šè¿‡Azureçš„Entra IDæœåŠ¡è¿›è¡Œèº«ä»½éªŒè¯ï¼ŒåŒæ—¶ä½¿ç”¨Kubernetesçš„RBACè¿›è¡Œæˆæƒã€‚
* Entra ID + Azure RBACï¼šç»“åˆä½¿ç”¨Azureçš„è§’è‰²åŸºç¡€è®¿é—®æ§åˆ¶å’ŒEntra IDè¿›è¡Œæ›´ç»†è‡´çš„è®¿é—®æ§åˆ¶ã€‚

å‰ææ¡ä»¶ï¼š

k8sé›†ç¾¤ç®¡ç†å‘˜å¯èƒ½è¿‡åº¦ä¿¡ä»»system:authenticatedè¿™ç±»ç”¨æˆ·ç»„ï¼Œä¾‹å¦‚æä¾›äº†`get secrets`æƒé™

åˆ©ç”¨æ­¥éª¤ï¼š

1. è·å–æœåŠ¡ä¸»ä½“å‡­è¯ï¼šæ”»å‡»è€…å¯èƒ½é€šè¿‡å„ç§æ‰‹æ®µè·å–åˆ°æœåŠ¡ä¸»ä½“çš„å‡­è¯ï¼Œè¿™äº›å‡­è¯å¯ä»¥è½¬æ¢ä¸º k8s tokenï¼Œè¡¨ç°ä¸º system:authenticated ç”¨æˆ·ç»„ï¼Œä½†å®é™…æƒé™è¾ƒä½ï¼Œ ä¾‹å¦‚æ— æ³• `kubectl get secrets`ã€‚
2. åˆ©ç”¨k8sé›†ç¾¤å¯¹system:authenticatedçš„ä¿¡ä»»æå‡æƒé™ã€‚

Ronen Shustin è¯´æ˜äº†ä¸Šè¿°é—®é¢˜åœ¨AKSã€GKEä¸­å­˜åœ¨ã€‚

### 2.4 åˆ©ç”¨ EKS pod identity å®ç°æƒé™æå‡

EKS pod identityé€šè¿‡IAMè§’è‰²ä¸ºæœåŠ¡è´¦æˆ· (IRSA) æä¾›äº†ä¸€ç§å®‰å…¨çš„æ–¹å¼æ¥å°†IAMè§’è‰²åˆ†é…ç»™Kubernetesä¸­çš„Podsã€‚è¿™å…è®¸Podsç›´æ¥ä½¿ç”¨IAMè§’è‰²çš„æƒé™ä¸AWSæœåŠ¡è¿›è¡Œäº¤äº’ï¼Œè€Œæ— éœ€åœ¨Podå†…éƒ¨æ˜ç¡®å­˜å‚¨AWSè®¿é—®å¯†é’¥ã€‚

Ronen Shustin å‡è®¾äº†ä¸€ç§å…·ä½“çš„æ”»å‡»åœºæ™¯ï¼Œæ”»å‡»è€…å¯èƒ½é€šè¿‡ç½‘ç»œæŠ“åŒ…(éœ€è¦host network+CAP_NET_RAW)ç­‰æŠ€æœ¯çªƒå–æ­£å¸¸ä¸šåŠ¡è·å–EKS pod identityçš„æµé‡, ä»è€Œçªƒå–IAMå‡­è¯ï¼Œå®ç°ææƒã€‚

## 3. ä¸ºä»€ä¹ˆéš¾ä»¥æ£€æµ‹

ç›®å‰ï¼Œk8sç³»ç»Ÿçº§çš„ç›¸å…³æ’ä»¶ï¼Œå±äºå®‰å…¨è¿è¥å›¢é˜Ÿçš„ç›‘æ§ç›²åŒºã€‚

ä¾‹å¦‚
* NPDæ¡ˆä¾‹ï¼Œä½œè€…é€šè¿‡ä¿®æ”¹å…¶é…ç½®æ–‡ä»¶æ¥å®ç°æŒä¹…åŒ–ï¼Œå†ç»“åˆæ¶æ„å‘½ä»¤è‡ªèº«çš„èº²é¿é˜²å¾¡æŠ€æœ¯ï¼Œå› å®‰å…¨è¿è¥å›¢é˜Ÿä¸ç†Ÿæ‚‰ç›¸å…³æ’ä»¶çš„è¡Œä¸ºï¼Œå¾ˆéš¾å¯Ÿè§‰åˆ°å¼‚å¸¸ã€‚
* fluentbitæ¡ˆä¾‹ï¼Œå› å…¶æœ¬èº«å°±æ˜¯æ•°æ®æ”¶é›†çš„åŠŸèƒ½ï¼Œé€šè¿‡å…¶é‡‡é›†ä»»ä½•æ•°æ®ï¼Œéƒ½ä¸æ˜“å¼•èµ·æ³¨æ„ã€‚

## 4. é˜²æŠ¤å»ºè®®

å®‰å…¨è¿è¥å›¢é˜Ÿéœ€è¦äº†è§£LOTLæŠ€æœ¯ï¼Œå¹¶æ£€æŸ¥ç³»ç»Ÿçº§æ’ä»¶ã€è¿›ç¨‹çš„é…ç½®æ–‡ä»¶å®‰å…¨æ€§ï¼Œç”šè‡³å»ºç«‹ç›¸å…³é…ç½®çš„ç™½åå•æœºåˆ¶ã€‚

## 5. å¯ç¤º

é’ˆå¯¹ç‰¹å®šäº‘å‚å•†K8Sç”šè‡³å¼¹æ€§è™šæ‹Ÿæœºç­‰äº§å“ï¼Œç ”ç©¶LOTLåˆ©ç”¨æŠ€æœ¯ï¼Œæœ‰åŠ©äºèº²é¿é˜²å¾¡ã€‚æœ‰å¿…è¦ç³»ç»Ÿæ€§åœ°é’ˆå¯¹äº‘å‚å•†Agentä½œå…¨é¢çš„æ¼æ´æŒ–æ˜åŠå¯åˆ©ç”¨æ€§åˆ†æã€‚

----

æœ¬æ–‡å‘å¸ƒå·²è·å¾—"äº‘åŸç”Ÿå®‰å…¨èµ„è®¯"é¡¹ç›®æˆæƒ, åŒæ­¥å‘å¸ƒäºä»¥ä¸‹å¹³å°

* github: [https://github.com/cloud-native-security-news/cloud-native-security-news](https://github.com/cloud-native-security-news/cloud-native-security-news)
* å…¬ä¼—å·: çŸ³å¤´çš„å®‰å…¨æ–™ç†å±‹

æ¬¢è¿åŠ å…¥ "äº‘åŸç”Ÿå®‰å…¨èµ„è®¯"é¡¹ç›® ğŸ‘ é˜…è¯»ã€å­¦ä¹ å’Œæ€»ç»“äº‘åŸç”Ÿå®‰å…¨ç›¸å…³èµ„è®¯ 
